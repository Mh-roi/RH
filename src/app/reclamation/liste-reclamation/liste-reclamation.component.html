<div class="container mx-auto p-4">
    <div class="mb-6 bg-white p-4 rounded shadow">
        <h2 class="text-xl font-bold mb-4">Filtres</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block mb-2">Recherche</label>
                <input
                    type="text"
                    [(ngModel)]="searchTerm"
                    (input)="applyFilters()"
                    class="w-full p-2 border rounded"
                />
            </div>
            <div>
                <label class="block mb-2">Statut</label>
                <select
                    [(ngModel)]="statutFilter"
                    (change)="applyFilters()"
                    class="w-full p-2 border rounded"
                >
                    <option value="">Tous</option>
                    <option value="Initié">Initié</option>
                    <option value="En cours">En cours</option>
                    <option value="Traité">Traité</option>
                </select>
            </div>
            <div>
                <label class="block mb-2">Décision</label>
                <select
                    [(ngModel)]="decisionFilter"
                    (change)="applyFilters()"
                    class="w-full p-2 border rounded"
                >
                    <option value="">Tous</option>
                    <option value="Favorable">Favorable</option>
                    <option value="Défavorable">Défavorable</option>
                    <option value="En attente">En attente</option>
                </select>
            </div>
        </div>
    </div>

    <div class="bg-white rounded shadow overflow-hidden">
        <table class="min-w-full">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-3 text-left">Référence Fiche</th>
                    <th class="p-3 text-left">Sujet</th>
                    <th class="p-3 text-left">Statut</th>
                    <th class="p-3 text-left">Décision</th>
                    <th class="p-3 text-left">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr
                    *ngFor="let reclamation of filteredReclamations"
                    class="border-t hover:bg-gray-50"
                >
                    <td class="p-3">{{ reclamation.ficheDTO?.reference }}</td>
                    <td class="p-3">{{ reclamation.sujet }}</td>
                    <td class="p-3">
                        <span
                            [ngClass]="{
                                'bg-blue-100 text-blue-800':
                                    reclamation.statutReclamation === 'Initié',
                                'bg-yellow-100 text-yellow-800':
                                    reclamation.statutReclamation ===
                                    'En cours',
                                'bg-green-100 text-green-800':
                                    reclamation.statutReclamation === 'Traité'
                            }"
                            class="px-2 py-1 rounded-full text-xs"
                        >
                            {{ reclamation.statutReclamation }}
                        </span>
                    </td>
                    <td class="p-3">{{ reclamation.decision }}</td>
                    <td class="p-3">
                        <button
                            pButton
                            label=""
                            icon="pi pi-exclamation-triangle"
                            class="p-button-success float-right"
                            id="reclamation"
                            (click)="traiterReclamation(reclamation)"
                            (click)="traiterReclamation(reclamation)"
                        ></button>
                        <button
                            pButton
                            label=""
                            icon="pi pi-eye"
                            class="p-button-info float-right p-m-2"
                            id="reclamation"
                            title="détail reclamation"
                            (click)="openModalToViewReclamation(reclamation)"
                        ></button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<p-dialog
    header="Traitement de la réclamation"
    [(visible)]="decisionDialog"
    [style]="{ width: '800px', minHeight: '500px' }"
    [modal]="true"
    [draggable]="false"
    [resizable]="true"
    [contentStyle]="{ 'max-height': '80vh', overflow: 'auto' }"
>
    <div class="p-fluid grid">
        <!-- Section Informations -->
        <div class="col-12 border-round border-1 surface-border p-3 bg-gray-50">
            <div class="grid">
                <div class="col-12 md:col-6">
                    <p>
                        <strong>Sujet :</strong> {{ currentReclamation?.sujet }}
                    </p>
                    <p>
                        <strong>Statut :</strong>
                        {{ currentReclamation?.statutReclamation }}
                    </p>
                </div>
                <div class="col-12 md:col-6">
                    <p>
                        <strong>Décision actuelle :</strong>
                        {{ currentReclamation?.decision || "Non définie" }}
                    </p>
                    <p *ngIf="currentReclamation?.ficheDTO">
                        <strong>Fiche liée :</strong>
                        {{ currentReclamation?.ficheDTO?.reference }}
                    </p>
                </div>
            </div>

            <div *ngIf="currentReclamation?.pieceJustificative" class="mt-2">
                <p-button
                    icon="pi pi-file-pdf"
                    label="Voir la pièce justificative"
                    styleClass="p-button-outlined p-button-secondary"
                    (onClick)="
                        openDocument(
                            currentReclamation?.pieceJustificative ?? ''
                        )
                    "
                >
                </p-button>
            </div>
        </div>

        <!-- Section Décision -->
        <div class="col-12 mt-4">
            <h3 class="text-lg font-medium mb-3">Nouvelle décision</h3>
            <div class="grid">
                <div class="col-12 md:col-6">
                    <p-dropdown
                        [(ngModel)]="selectedDecision"
                        [options]="decisionOptions"
                        optionLabel="label"
                        placeholder="Choisir une décision"
                        [showClear]="true"
                        styleClass="w-full"
                    >
                        <ng-template let-item pTemplate="item">
                            <div class="flex align-items-center">
                                <i [class]="item.icon" class="mr-2"></i>
                                <span>{{ item.label }}</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
                <div class="col-12 md:col-6">
                    <div
                        *ngIf="selectedDecision"
                        class="p-3 border-round"
                        [ngClass]="{
                            'bg-green-100 text-green-800':
                                selectedDecision.value === 'FAVORABLE',
                            'bg-red-100 text-red-800':
                                selectedDecision.value === 'DEFAVORABLE'
                        }"
                    >
                        <i [class]="selectedDecision.icon" class="mr-2"></i>
                        {{ selectedDecision.label }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Commentaire -->
        <div class="col-12 mt-3"></div>

        <!-- Avertissement -->
        <div
            *ngIf="selectedDecision?.value === 'FAVORABLE'"
            class="col-12 mt-3"
        >
            <span class="text-red-600">
                <i class="pi pi-exclamation-triangle mr-2"></i>
                <strong>Avertissement :</strong>
                Une décision favorable entraînera la modification de la fiche
                associée et des pointages concernés.
            </span>
            <!-- <p-message severity="warn">
                <ng-template pTemplate>
                    <div class="flex align-items-center">
                        <i class="pi pi-exclamation-triangle mr-2"></i>
                        <span>
                            Une décision favorable entraînera la modification de
                            la fiche associée et des pointages concernés.
                        </span>
                    </div>
                </ng-template>
            </p-message> -->
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-between w-full">
            <button
                pButton
                pRipple
                label="Annuler"
                icon="pi pi-times"
                class="p-button-text"
                (click)="closeDialog()"
            ></button>
            <div>
                <button
                    pButton
                    pRipple
                    label="Enregistrer comme brouillon"
                    icon="pi pi-save"
                    class="p-button-secondary mr-2"
                    (click)="saveAsDraft()"
                ></button>
                <button
                    pButton
                    pRipple
                    label="Confirmer la décision"
                    icon="pi pi-check"
                    class="p-button-success"
                    [disabled]="!selectedDecision"
                    (click)="confirmerDecision()"
                ></button>
            </div>
        </div>
    </ng-template>
</p-dialog>
